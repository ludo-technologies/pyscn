# **要件定義書：次世代Pythonコード品質ツール「pyqol」**

## **1. 概要**

### **1.1. プロジェクトの目的**

本プロジェクトは、Python開発者の**「コード品質（Quality）」**と**「生活の質（Quality of Life）」**を向上させる、次世代の静的解析ツール「pyqol」を開発することを目的とする。

従来のルールベースのリンター（Linter）が提供する「問題の指摘」に留まらず、コードの構造的な健全性を深く分析し、**実用的なリファクタリング提案**と**段階的な品質改善**を支援する。

### **1.2. ターゲットユーザー**

#### **プライマリユーザー**
* 10人以下の開発チームで働く中級Python開発者
* コード品質に関心があるが、時間的制約のある個人開発者

#### **セカンダリユーザー**
* 大規模プロジェクトのテックリード
* コードレビューの効率化を求める開発マネージャー

### **1.3. 競合分析と差別化**

| ツール | 強み | pyqolの差別化ポイント |
| :---- | :---- | :---- |
| **Ruff** | 超高速、Pythonリンターの統合 | CFGベースの構造解析により、表層的でない深い問題を検出 |
| **Pylint** | 包括的なルールセット | APTEDによる構造的類似性分析で、より賢いコードクローン検出 |
| **mypy** | 型チェック特化 | 型以外の設計問題（凝集度、結合度）にフォーカス |
| **Bandit** | セキュリティ特化 | 設計とアーキテクチャの改善に特化 |

## **2. MVP（最小実行可能製品）定義**

### **2.1. 1ヶ月スプリントMVP（v0.1.0）**

**Claude Codeを活用した高速開発により、1ヶ月でコア技術を全て実装**

| 機能ID | 機能名 | 優先度 | 実装日数 |
| :---- | :---- | :---- | :---- |
| **MVP-01** | Tree-sitter統合によるPython解析 | P0 | 2日 |
| **MVP-02** | CFG構築とデッドコード検出 | P0 | 5日 |
| **MVP-03** | APTEDによるコードクローン検出 | P0 | 5日 |
| **MVP-04** | CLIと設定ファイル | P0 | 2日 |

**目標リリース日**: 2025年9月6日（1ヶ月後）

## **3. 機能要件**

### **3.1. MVPコア機能（全てFree版）**

| 機能ID | 機能名 | 機能概要 | 技術要素 | 目標性能 |
| :---- | :---- | :---- | :---- | :---- |
| **F-101** | **CFGデッドコード検出** | 制御フローグラフによる高精度検出 | Tree-sitter, CFG | 10万行/10秒 |
| **F-102** | **APTEDクローン検出** | 木編集距離による構造的類似検出 | Tree-sitter, APTED | 1万行/30秒 |
| **F-103** | **複雑度メトリクス** | サイクロマティック複雑度とLCOM4 | CFG, AST | リアルタイム |

### **3.2. フェーズ2：拡張機能（Free版）**

| 機能ID | 機能名 | 機能概要 | 技術要素 | 実装時期 |
| :---- | :---- | :---- | :---- | :---- |
| **F-201** | **依存関係分析** | モジュール間の循環依存検出 | Import解析 | v0.2.0 |
| **F-202** | **パフォーマンス分析** | 非効率なループパターン検出 | CFG, AST | v0.2.0 |
| **F-203** | **VS Code拡張** | リアルタイムフィードバック | LSP | v0.3.0 |

### **3.3. フェーズ3：Pro版機能（有償）**

| 機能ID | 機能名 | 機能概要 | 技術要素 | APIコスト見積 |
| :---- | :---- | :---- | :---- | :---- |
| **F-301** | **AIリファクタリング提案** | LLMによる重複コードの統合提案 | OpenAI API | $0.01/提案 |
| **F-302** | **自然言語コード解説** | 選択コードの平易な説明生成 | GPT-4 | $0.02/解説 |
| **F-303** | **対話型改善アシスタント** | チャット形式での改善相談 | GPT-4 | $0.03/会話 |

## **4. 非機能要件**

### **4.1. パフォーマンス要件**

| 項目 | 目標値 | 測定条件 |
| :---- | :---- | :---- |
| **基本解析速度** | 100,000行/秒以上 | CFG無効時 |
| **CFG解析速度** | 10,000行/秒以上 | 全機能有効時 |
| **メモリ使用量** | 解析対象の10倍以内 | 最大1GBまで |
| **起動時間** | 100ms以内 | コールドスタート |

### **4.2. 精度要件**

| 項目 | 目標値 | 備考 |
| :---- | :---- | :---- |
| **False Positive率** | 5%以下 | デッドコード検出 |
| **False Negative率** | 10%以下 | クローン検出 |

### **4.3. 統合要件**

* **エディタ連携**: VS Code拡張機能（Phase 2）
* **CI/CD連携**: GitHub Actions、GitLab CI対応
* **設定形式**: pyproject.toml、.pyqol.yaml
* **出力形式**: JSON、SARIF、人間可読形式

## **5. 技術アーキテクチャ**

### **5.1. コア技術スタック**

```yaml
言語: Go 1.21+
理由: 
  - 単一バイナリ配布
  - 高速並列処理
  - 低メモリフットプリント

Python解析:
  ライブラリ: go-tree-sitter
  対応バージョン: Python 3.8-3.12
  
CFG構築:
  実装: 独自実装
  最大ノード数: 10,000/関数
  
APTED:
  実装: 既存ライブラリのGo移植
  最大ツリーサイズ: 1,000ノード
```

### **5.2. LLM統合仕様**

```yaml
対応プロバイダ:
  - OpenAI (GPT-3.5/4)
  - Anthropic Claude (将来対応)
  
レート制限:
  - 10リクエスト/分/ユーザー
  - 1000リクエスト/月/無料枠
  
キャッシュ:
  - Redis/ローカルSQLite
  - TTL: 7日間
```

## **6. ビジネスモデル**

### **6.1. 料金プラン**

| プラン | 月額料金 | 年額料金 | 主要機能 | LLM利用上限 |
| :---- | :---- | :---- | :---- | :---- |
| **Free** | $0 | $0 | 全解析機能 | 0 |
| **Pro Personal** | $9 | $90 | Free + AI機能 | 1,000回/月 |
| **Pro Team** | $29/user | $290/user | Pro + チーム機能 | 5,000回/月 |
| **Enterprise** | 要相談 | 要相談 | 全機能 + SLA | 無制限 |

### **6.2. 収益予測**

```
目標（1年後）:
- Freeユーザー: 10,000人
- Pro Personal: 500人 (5%変換率)
- Pro Team: 50チーム × 5人
- 月間経常収益(MRR): $11,750
```

## **7. 開発ロードマップ（高速版）**

### **Sprint 1: MVP (1ヶ月) - コア技術完全実装**
#### Week 1 (8/6-8/12)
- [x] 要件定義完了
- [ ] Go環境 + Tree-sitter統合
- [ ] Python AST構築と基本解析
- [ ] CFG構築アルゴリズム実装

#### Week 2 (8/13-8/19)
- [ ] CFGベースデッドコード検出
- [ ] 到達不能コード検出
- [ ] 未使用関数・変数検出
- [ ] サイクロマティック複雑度計算

#### Week 3 (8/20-8/26)
- [ ] APTEDアルゴリズム実装
- [ ] 構造的クローン検出
- [ ] 類似度闾値設定機能
- [ ] クローンレポート生成

#### Week 4 (8/27-9/2)
- [ ] CLI実装（cobra）+ 出力フォーマット
- [ ] テストスイート + ベンチマーク
- [ ] ドキュメント + CI/CD
- [ ] **オープンソース公開** 🚀

### **Sprint 2: 拡張機能 (1ヶ月)**
- [ ] CFG実装
- [ ] クローン検出（基本版）
- [ ] パフォーマンス最適化
- [ ] VS Code拡張（基本版）

### **Sprint 3: Pro版準備 (1ヶ月)**
- [ ] APTED実装
- [ ] LLM統合準備
- [ ] 有料プラン機能分離
- [ ] ベータテスト開始

## **8. リスクと対策**

| リスク | 影響度 | 発生確率 | 対策 |
| :---- | :---- | :---- | :---- |
| Tree-sitterのGo実装が不安定 | 高 | 中 | 代替パーサーの調査 |
| LLMコストの高騰 | 高 | 中 | モデル切り替え、キャッシュ強化 |
| 競合の機能追従 | 中 | 高 | 独自機能への注力 |
| False Positive率が高い | 高 | 中 | 段階的な感度調整機能 |

## **9. 成功指標（KPI）**

### **技術的KPI**
- 解析速度: Ruffの80%以上
- False Positive率: 5%以下
- クラッシュ率: 0.1%以下

### **ビジネスKPI**
- 月間アクティブユーザー: 1,000人（6ヶ月後）
- 有料変換率: 5%以上
- チャーンレート: 10%以下/月
- NPS: 40以上

## **10. オープンソース戦略**

### **10.1. 早期オープンソース化戦略**

**1ヶ月後（2025年9月6日）** に即座にオープンソース化：

- **ライセンス**: MIT License（全コード）
- **初期公開範囲**: MVP機能のみ
- **リポジトリ**: GitHub（pyqol/pyqol）
- **戦略**: "Build in Public" - 開発過程も公開

### **10.2. 早期公開のメリット**

- **コミュニティフィードバック**: 早期から方向性の検証
- **コントリビューター獲得**: 初期から開発参加を促進
- **透明性による信頼構築**: オープンな開発で信頼獲得
- **高速イテレーション**: ユーザーフィードバックで改善加速

### **10.3. リポジトリ構造（初期）**

```
pyqol/
├── cmd/            # CLIエントリーポイント
├── internal/       # 内部パッケージ
│   ├── parser/     # Tree-sitter統合
│   ├── analyzer/   # デッドコード検出
│   └── config/     # 設定管理
├── pkg/            # 公開パッケージ
├── testdata/       # テスト用データ
└── docs/           # ドキュメント
```

### **10.4. コミュニティ形成計画**

- **Week 1-3**: プライベート開発
- **Week 4**: パブリックリポジトリ公開
- **Month 2**: Hacker News、Reddit投稿
- **Month 3**: 初回リリースパーティ（オンライン）

## **11. 今日からの実装計画**

### **Day 1-3: 基盤構築**
```bash
# プロジェクト初期化
go mod init github.com/pyqol/pyqol
go get github.com/smacker/go-tree-sitter
go get github.com/spf13/cobra
```

### **Day 4-8: CFG実装**
- Tree-sitter-python統合
- ASTからCFG構築
- デッドコード検出アルゴリズム
- 複雑度計算

### **Day 9-14: APTED実装**
- APTEDアルゴリズムのGo実装
- ASTノードの比較処理
- クローン検出ロジック
- 類似度闾値設定

### **Day 15-18: CLIと出力**
- Cobra CLI実装
- JSON/Text/SARIF出力
- 設定ファイルサポート

### **Day 19-24: 品質保証**
- 単体テスト
- 統合テスト
- パフォーマンスベンチマーク

### **Day 25-30: 公開準備**
- ドキュメント作成
- CI/CD設定
- デモ動画作成
- **🚀 オープンソース公開**

---

*本要件定義書は、アジャイル開発の原則に基づき、継続的に更新されるものとする。*

*最終更新日: 2025-08-06*